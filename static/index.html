<!DOCTYPE html>
<html lang="de">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Freifunk Hamburg - fastd Key eintragen</title>

    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css" />
    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script>
        var validationMessages = {
            key: "Der angegebene VPN-Schlüssel ist ungültig.",
            hostname: "Knotennamen dürfen maximal 32 Zeichen lang sein und nur Klein- und Großbuchstaben, sowie Ziffern, - und _ enthalten.",
            email: "Die angegebene E-Mail-Adresse ist ungültig.",
            nickname: "Nicknames dürfen maximal 64 Zeichen lang sein und nur Klein- und Großbuchstaben, sowie Ziffern, - und _ enthalten. Umlaute sind erlaubt.",
            mac: "Die angegebene MAC-Adresse ist ungültig.",
            coords: "Bitte gib die Koordinaten wie folgt an, Beispiel: 54.326230588201 10.101561821008"
        };

        function feedback(cls, msg) {
            var html = "";
            html += "<div class=\"alert " + cls + "\">";
            html += msg;
            html += "<a class=\"close\" data-dismiss=\"alert\" href=\"#\">&times;</a>";
            html += "</div>";

            var div = $(html);
            $("#feedback").append(div);
        }

        function clearFeedback() {
            $("#feedback").empty();
        }

        function success(msg) {
            feedback("alert-success", msg);
            $("form")[0].reset();            
        }

        function error(msg) {
            feedback("alert-danger", msg);
        }

        function updateValidationErrors(fields) {
            $(".form-group.has-error").toggleClass("has-error", false);
            $(".form-group .feedback").empty();

            for (var i = 0; i < fields.length; i++) {
                var field = fields[i];
                $(".form-group." + field).toggleClass("has-error", true);
                $(".form-group." + field + " .feedback").text(validationMessages[field]);
            }
        }

        function handleSubmit(e) {
            if (e) {
                e.preventDefault();
            }

            clearFeedback();
            updateValidationErrors([]);

            var hostname = $("input[name=hostname]").val();
            var key = $("input[name=key]").val();
            var email = $("input[name=email]").val();
            var nickname= $("input[name=nickname]").val();
            var coords = $("input[name=coords]").val();
            var mac = $("input[name=mac]").val();

            $.ajax("/api/node", {
                type: "POST",
                data: {
                    hostname: hostname,
                    key: key,
                    email: email,
                    nickname: nickname,
                    coords: coords,
                    mac: mac
                },
                success: function () {
                    success("Glückwunsch, der Knoten ist jetzt angemeldet!");
                },
                error: function (jqxhr) {
                    var result = JSON.parse(jqxhr.responseText);

                    switch (result.type) {
                        case "ValidationError":
                            updateValidationErrors(result.validationResult.missing.concat(result.validationResult.invalid));
                        break;
                        case "NodeEntryAlreadyExistsError":
                            error("Für den Knoten " + result.hostname + " existiert bereits ein Eintrag.");
                        break;
                        case "MacEntryAlreadyExistsError":
                            error("Für die MAC-Adresse " + result.mac + " existiert bereits ein Eintrag.");
                        break;
                        case "KeyEntryAlreadyExistsError":
                            error("Für den VPN-Schlüssel " + result.key + " existiert bereits ein Eintrag.");
                        break;
                        default:
                            error("Es ist ein unerwarteter Fehler aufgetreten.");
                    }
                }
            });

            return false;
        }

        $(document).ready(function () {
            $("form button[type='submit'],form input[type='text']").removeAttr("disabled");
            $("form").submit(handleSubmit);
        });
    </script>

</head>

<body>
    <div class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="https://hamburg.freifunk.net">hamburg.freifunk.net</a>
        </div>
      </div>
    </div>

    <div class="container">
        <h1>Knoten anmelden</h1>

        <div class="container well">
            <noscript>
                <div class="alert alert-danger">
                    <h4>Achtung!</h4>
                    Du hast kein JavaScript aktiviert oder dein Browser unterstützt kein
                    JavaScript. Bitte aktiviere JavaScript oder nutze einen anderen Browser,
                    um deinen Freifunk-Knoten registrieren zu können.
                </div>
            </noscript>

            <form method="post" role="form">
                <div id="feedback"></div>
                <fieldset>
                    <div class="form-group hostname">
                        <label class="control-label" for="hostname">Knotenname</label>
                        <input type="text" disabled="disabled" class="form-control" name="hostname" placeholder="Knotenname" />
                        <span class="feedback help-block"></span>
                    </div>
                    <div class="form-group key">
                        <label class="control-label" for="key">VPN-Schlüssel (bitte nur weglassen, wenn du weisst, was du tust)</label>
                        <input type="text" disabled="disabled" class="form-control" name="key" placeholder="VPN-Schlüssel" />
                        <span class="feedback help-block"></span>
                    </div>
                    <div class="form-group mac">
                        <label class="control-label" for="mac">MAC-Adresse</label>
                        <input type="text" disabled="disabled" class="form-control" name="mac" placeholder="MAC-Adresse" />
                        <span class="feedback help-block"></span>
                    </div>
                    <div class="form-group nickname">
                        <label class="control-label" for="nickname">Kontakt - Nickname / Name</label>
                        <input type="text" disabled="disabled" class="form-control" name="nickname" placeholder="Kontakt - Nickname / Name" />
                        <span class="feedback help-block"></span>
                    </div>
                    <div class="form-group email">
                        <label class="control-label" for="email">Kontakt - E-Mail-Adresse</label>
                        <input type="text" disabled="disabled" class="form-control" name="email" placeholder="Kontakt - E-Mail-Adresse" />
                        <span class="feedback help-block"></span>
                    </div>
                    <div class="form-group coords">
                        <label class="control-label" for="coords">Koordinaten des Knotens (freiwillig)</label>
                        <input type="text" disabled="disabled" class="form-control" name="coords" placeholder="Koordinaten" />
                        <span class="feedback help-block"></span>
                        <span class="help-block">
                            Du kannst die Koordinaten in der <a target="_blank" href="http://freifunk-gw01.hamburg.ccc.de/ffhhmap/geomap.html">Knotenkarte</a>
                            rausfinden, indem du zum Standort des Knotens gehst, dann oben "Koordinaten beim
                            nächsten Klick anzeigen" klickst und dann auf der Karte auf den genauen Standort
                            klickst.
                        </span>
                    </div>
                    <button class="btn btn-primary" type="submit" disabled="disabled">
                        <strong>+</strong>
                        Knoten eintragen
                    </button>
                </fieldset>
            </form>
        </div>
    </div>
</body>

</html>

